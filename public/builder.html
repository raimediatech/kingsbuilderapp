<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KingsBuilder - Professional Page Builder</title>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="./favicon.ico">
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- KingsBuilder Core Styles -->
    <link rel="stylesheet" href="./kingsbuilder-core.css?v=19">
    
    <!-- Meta Tags -->
    <meta name="description" content="Professional drag & drop page builder for Shopify">
    <meta name="author" content="KingsBuilder Team">
    <meta name="robots" content="noindex, nofollow">
</head>
<body>
    <!-- Loading Screen -->
    <div id="kb-loading" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: #ffffff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 20000;
        font-family: 'Inter', sans-serif;
    ">
        <div style="
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #000000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        "></div>
        <h2 style="color: #333; margin: 0 0 10px 0; font-weight: 600;">
            <i class="fas fa-crown" style="color: #000000; margin-right: 10px;"></i>
            KingsBuilder
        </h2>
        <p style="color: #666; margin: 0; font-size: 14px;">Loading professional page builder...</p>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }        }

        /* Elementor Column Resize Handles */
        .elementor-resizable-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 10px;
            cursor: col-resize;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .elementor-resizable-handle-e {
            right: -5px;
        }

        .elementor-column:hover .elementor-resizable-handle {
            opacity: 1;
        }

        .elementor-resizable-handle-line {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 30px;
            background: #71d7f7;
            border-radius: 1px;
        }

        .elementor-resizable-handle:hover .elementor-resizable-handle-line {
            background: #0073aa;
        }

        .elementor-column {
            position: relative;
            width: 100%;
            flex: 0 0 100%;
            max-width: 100%;
        }

        .elementor-section .elementor-container {
            display: flex;
            flex-wrap: wrap;
            width: 100%;
        }

        .elementor-col-100 {
            width: 100% !important;
            flex: 0 0 100% !important;
        }

        .elementor-widget-wrap {
            width: 100%;
            min-height: 50px;
        }
    </style>

    <!-- Widget Files (Load first for BaseWidget) -->
    <script src="./widgets-base.js?v=17"></script>
    <script src="./widgets-advanced.js?v=17"></script>
    
    <!-- Core JavaScript Files (Load managers first, then core) -->
    <script src="./container-system.js?v=17"></script>
    <script src="./widget-manager.js?v=21"></script>
    <script>
/**
 * KingsBuilder Canvas Manager - Complete Elementor Clone
 */
class CanvasManager {
    constructor() {
        this.canvas = null;
        this.containerSystem = null;
        this.initialized = false;
        this.selectedElement = null;
        this.dropIndicators = [];
        console.log("?? Elementor Canvas Manager");
    }

    async init() {
        if (this.initialized) return;
        this.canvas = document.getElementById("kb-canvas");
        if (!this.canvas) return;

        this.containerSystem = new ContainerSystem();
        await this.containerSystem.init();
        
        this.setupElementor();
        this.bindEvents();
        this.updateCanvasEmpty();
        this.initialized = true;
        console.log("? Elementor Canvas Ready");
    }

    setupElementor() {
        this.canvas.classList.add("elementor", "elementor-edit-mode");
        this.canvas.addEventListener("dragover", this.handleDragOver.bind(this));
        this.canvas.addEventListener("drop", this.handleDrop.bind(this));
        this.canvas.addEventListener("dragenter", (e) => e.preventDefault());
        this.canvas.addEventListener("dragleave", this.handleDragLeave.bind(this));
    }

    bindEvents() {
        this.canvas.addEventListener("click", (e) => {
            if (e.target === this.canvas || e.target.classList.contains("kb-canvas-empty")) {
                this.deselectAll();
            }
        });
    }

    handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "copy";
        this.canvas.classList.add("kb-drag-over");
        this.showDropIndicators(e);
    }

    handleDragLeave(e) {
        if (!this.canvas.contains(e.relatedTarget)) {
            this.canvas.classList.remove("kb-drag-over");
            this.hideDropIndicators();
        }
    }

    handleDrop(e) {
        e.preventDefault();
        const dragData = e.dataTransfer.getData("text/plain");
        if (!dragData) return;

        window.kingsBuilder.saveState();

        if (dragData.startsWith("container-")) {
            this.dropContainer(e, dragData.replace("container-", ""));
        } else {
            this.dropWidget(e, dragData);
        }

        this.cleanup();
    }

    dropWidget(e, widgetType) {
        const element = window.kingsBuilder.widgetManager.createWidget(widgetType);
        if (!element) return;

        element.classList.add("elementor-element", "elementor-widget", `elementor-widget-${widgetType}`);
        element.dataset.element_type = "widget";
        
        const dropInfo = this.getDropPosition(e);
        
        if (dropInfo.column) {
            this.insertInColumn(element, dropInfo);
        } else {
            this.createSectionWithWidget(element, dropInfo);
        }

        this.selectElement(element);
        this.updateNavigator();
    }

    dropContainer(e, containerType) {
        const section = this.createSection(containerType);
        const dropInfo = this.getDropPosition(e);
        this.insertSection(section, dropInfo);
        this.selectElement(section);
        this.updateNavigator();
    }

    createSection(type = "section") {
        const section = document.createElement("section");
        section.className = "elementor-section elementor-top-section kb-container";
        section.dataset.id = this.generateId();
        section.dataset.element_type = "section";
        section.dataset.containerType = type;
        
        const container = document.createElement("div");
        container.className = "elementor-container elementor-column-gap-default";
        
        const column = this.createColumn();
        container.appendChild(column);
        section.appendChild(container);
        
        this.makeInteractive(section);
        return section;
    }

    createColumn(width = 100) {
        const column = document.createElement("div");
        column.className = "elementor-column elementor-col-100 elementor-top-column kb-column";
        column.style.width = "100%";
        column.style.flex = "0 0 100%";
        column.dataset.id = this.generateId();
        column.dataset.element_type = "column";
        
        // Add resize handles
        const resizeHandle = document.createElement("div");
        resizeHandle.className = "elementor-resizable-handle elementor-resizable-handle-e";
        resizeHandle.innerHTML = '<div class="elementor-resizable-handle-line"></div>';
        
        const wrapper = document.createElement("div");
        wrapper.className = "elementor-widget-wrap elementor-element-populated";
        
        const empty = document.createElement("div");
        empty.className = "kb-empty-state";
        empty.innerHTML = "<i class=\"fas fa-plus\"></i><span>Drop widgets here</span>";
        wrapper.appendChild(empty);
        
        column.appendChild(wrapper);
        column.appendChild(resizeHandle);
        
        this.makeInteractive(column);
        this.addColumnResize(column);
        return column;
    }

    addColumnResize(column) {
        const handle = column.querySelector('.elementor-resizable-handle');
        if (!handle) return;

        let isResizing = false;
        let startX = 0;
        let startWidth = 0;

        handle.addEventListener('mousedown', (e) => {
            isResizing = true;
            startX = e.clientX;
            startWidth = column.offsetWidth;
            document.body.style.cursor = 'col-resize';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            
            const diff = e.clientX - startX;
            const newWidth = startWidth + diff;
            const container = column.parentElement;
            const containerWidth = container.offsetWidth;
            const percentage = Math.max(10, Math.min(90, (newWidth / containerWidth) * 100));
            
            column.style.width = percentage + '%';
            column.className = column.className.replace(/elementor-col-\d+/, `elementor-col-${Math.round(percentage)}`);
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
            }
        });
    }

    createSectionWithWidget(widget, dropInfo) {
        const section = this.createSection();
        const wrapper = section.querySelector(".elementor-widget-wrap");
        wrapper.querySelector(".kb-empty-state").remove();
        wrapper.appendChild(widget);
        this.insertSection(section, dropInfo);
    }

    insertInColumn(widget, dropInfo) {
        const { column, insertBefore } = dropInfo;
        const wrapper = column.querySelector(".elementor-widget-wrap");
        
        const emptyState = wrapper.querySelector(".kb-empty-state");
        if (emptyState) emptyState.remove();
        
        if (insertBefore) {
            wrapper.insertBefore(widget, insertBefore);
        } else {
            wrapper.appendChild(widget);
        }
    }

    insertSection(section, dropInfo) {
        if (dropInfo.insertBefore) {
            this.canvas.insertBefore(section, dropInfo.insertBefore);
        } else {
            this.canvas.appendChild(section);
        }
    }

    getDropPosition(e) {
        const mouseY = e.clientY;
        const sections = Array.from(this.canvas.children).filter(el => 
            el.classList.contains("elementor-section")
        );
        
        for (const section of sections) {
            const rect = section.getBoundingClientRect();
            if (mouseY >= rect.top && mouseY <= rect.bottom) {
                const columns = section.querySelectorAll(".elementor-column");
                for (const column of columns) {
                    const colRect = column.getBoundingClientRect();
                    if (e.clientX >= colRect.left && e.clientX <= colRect.right) {
                        return {
                            column,
                            insertBefore: this.getColumnInsertPosition(e, column)
                        };
                    }
                }
            }
        }
        
        let insertBefore = null;
        for (const section of sections) {
            const rect = section.getBoundingClientRect();
            if (mouseY < rect.top + rect.height / 2) {
                insertBefore = section;
                break;
            }
        }
        
        return { insertBefore };
    }

    getColumnInsertPosition(e, column) {
        const wrapper = column.querySelector(".elementor-widget-wrap");
        const widgets = Array.from(wrapper.children).filter(el => 
            !el.classList.contains("kb-empty-state")
        );
        
        const mouseY = e.clientY;
        for (const widget of widgets) {
            const rect = widget.getBoundingClientRect();
            if (mouseY < rect.top + rect.height / 2) {
                return widget;
            }
        }
        return null;
    }

    showDropIndicators(e) {
        this.hideDropIndicators();
        const dropInfo = this.getDropPosition(e);
        
        if (dropInfo.column) {
            this.showColumnIndicator(e, dropInfo.column);
        } else {
            this.showSectionIndicator(e);
        }
    }

    showColumnIndicator(e, column) {
        const wrapper = column.querySelector(".elementor-widget-wrap");
        const indicator = document.createElement("div");
        indicator.className = "kb-drop-indicator elementor-drop-indicator";
        
        const insertBefore = this.getColumnInsertPosition(e, column);
        if (insertBefore) {
            wrapper.insertBefore(indicator, insertBefore);
        } else {
            wrapper.appendChild(indicator);
        }
    }

    showSectionIndicator(e) {
        const indicator = document.createElement("div");
        indicator.className = "kb-drop-indicator elementor-section-drop-indicator";
        indicator.innerHTML = "<div class=\"elementor-drop-line\"></div>";
        
        const dropInfo = this.getDropPosition(e);
        if (dropInfo.insertBefore) {
            this.canvas.insertBefore(indicator, dropInfo.insertBefore);
        } else {
            this.canvas.appendChild(indicator);
        }
    }

    hideDropIndicators() {
        this.canvas.querySelectorAll(".kb-drop-indicator").forEach(el => el.remove());
    }

    makeInteractive(element) {
        element.addEventListener("mouseenter", () => {
            if (element !== this.selectedElement) {
                element.classList.add("elementor-element-hover");
            }
        });
        
        element.addEventListener("mouseleave", () => {
            element.classList.remove("elementor-element-hover");
        });
        
        element.addEventListener("click", (e) => {
            e.stopPropagation();
            this.selectElement(element);
        });
        
        this.addEditOverlay(element);
    }

    addEditOverlay(element) {
        const overlay = document.createElement("div");
        overlay.className = "elementor-element-overlay";
        
        const controls = document.createElement("div");
        controls.className = "elementor-editor-element-settings";
        controls.innerHTML = `
            <ul class="elementor-editor-element-settings-list">
                <li class="elementor-editor-element-setting elementor-editor-element-edit">
                    <a href="#" title="Edit"><i class="eicon-edit"></i></a>
                </li>
                <li class="elementor-editor-element-setting elementor-editor-element-duplicate">
                    <a href="#" title="Duplicate"><i class="eicon-clone"></i></a>
                </li>
                <li class="elementor-editor-element-setting elementor-editor-element-remove">
                    <a href="#" title="Delete"><i class="eicon-close"></i></a>
                </li>
            </ul>
        `;
        
        overlay.appendChild(controls);
        element.appendChild(overlay);
        
        controls.addEventListener("click", (e) => {
            e.stopPropagation();
            const action = e.target.closest("li");
            if (!action) return;
            
            if (action.classList.contains("elementor-editor-element-edit")) {
                this.editElement(element);
            } else if (action.classList.contains("elementor-editor-element-duplicate")) {
                this.duplicateElement(element);
            } else if (action.classList.contains("elementor-editor-element-remove")) {
                this.deleteElement(element);
            }
        });
    }

    selectElement(element) {
        this.deselectAll();
        this.selectedElement = element;
        element.classList.add("elementor-element-edit-mode");
        window.kingsBuilder.selectElement(element);
    }

    deselectAll() {
        if (this.selectedElement) {
            this.selectedElement.classList.remove("elementor-element-edit-mode");
            this.selectedElement = null;
        }
        this.canvas.querySelectorAll(".elementor-element-edit-mode").forEach(el => {
            el.classList.remove("elementor-element-edit-mode");
        });
        
        // Show page settings when nothing is selected
        window.kingsBuilder.selectElement(null);
    }

    editElement(element) {
        this.selectElement(element);
        const panel = document.getElementById("kb-properties-panel");
        if (panel) panel.classList.add("active");
    }

    duplicateElement(element) {
        const clone = element.cloneNode(true);
        clone.dataset.id = this.generateId();
        element.parentNode.insertBefore(clone, element.nextSibling);
        this.makeInteractive(clone);
        clone.querySelectorAll(".elementor-column, .elementor-widget").forEach(child => {
            this.makeInteractive(child);
        });
        this.updateNavigator();
    }

    deleteElement(element) {
        if (confirm("Delete this element?")) {
            element.remove();
            this.updateNavigator();
            this.updateCanvasEmpty();
        }
    }

    cleanup() {
        this.canvas.classList.remove("kb-drag-over");
        this.hideDropIndicators();
        this.updateCanvasEmpty();
    }

    updateCanvasEmpty() {
        const emptyState = this.canvas.querySelector(".kb-canvas-empty");
        const hasContent = this.canvas.querySelector(".elementor-section");
        
        if (hasContent && emptyState) {
            emptyState.remove();
        } else if (!hasContent && !emptyState) {
            const empty = document.createElement("div");
            empty.className = "kb-canvas-empty";
            empty.innerHTML = `
                <div class="kb-empty-content">
                    <i class="eicon-plus"></i>
                    <h3>Start Building</h3>
                    <p>Drag widgets to begin</p>
                </div>
            `;
            this.canvas.appendChild(empty);
        }
    }

    updateNavigator() {
        const tree = document.getElementById("kb-navigator-tree");
        if (!tree) return;
        
        const sections = Array.from(this.canvas.children).filter(el => 
            el.classList.contains("elementor-section")
        );
        
        if (sections.length === 0) {
            tree.innerHTML = "<div class=\"kb-navigator-empty\"><i class=\"eicon-navigator\"></i><p>No elements</p></div>";
            return;
        }
        
        let html = "<div class=\"elementor-navigator\">";
        sections.forEach(section => {
            html += this.renderNavigatorSection(section);
        });
        html += "</div>";
        
        tree.innerHTML = html;
        this.bindNavigatorEvents();
    }

    renderNavigatorSection(section) {
        const sectionId = section.dataset.id;
        let html = `
            <div class="elementor-navigator-element" data-element-id="${sectionId}">
                <div class="elementor-navigator-element__element">
                    <div class="elementor-navigator-element__icon">
                        <i class="eicon-section"></i>
                    </div>
                    <div class="elementor-navigator-element__title">Section</div>
                </div>
                <div class="elementor-navigator-element__list">
        `;
        
        const columns = section.querySelectorAll(".elementor-column");
        columns.forEach(column => {
            const columnId = column.dataset.id;
            html += `
                <div class="elementor-navigator-element" data-element-id="${columnId}">
                    <div class="elementor-navigator-element__element">
                        <div class="elementor-navigator-element__icon">
                            <i class="eicon-column"></i>
                        </div>
                        <div class="elementor-navigator-element__title">Column</div>
                    </div>
                    <div class="elementor-navigator-element__list">
            `;
            
            const widgets = column.querySelectorAll(".elementor-widget");
            widgets.forEach(widget => {
                const widgetId = widget.dataset.id;
                const widgetType = widget.dataset.widget || "widget";
                html += `
                    <div class="elementor-navigator-element" data-element-id="${widgetId}">
                        <div class="elementor-navigator-element__element">
                            <div class="elementor-navigator-element__icon">
                                <i class="eicon-widget"></i>
                            </div>
                            <div class="elementor-navigator-element__title">${widgetType}</div>
                        </div>
                    </div>
                `;
            });
            
            html += "</div></div>";
        });
        
        html += "</div></div>";
        return html;
    }

    bindNavigatorEvents() {
        const elements = document.querySelectorAll(".elementor-navigator-element");
        elements.forEach(item => {
            const elementId = item.dataset.elementId;
            const element = document.querySelector(`[data-id="${elementId}"]`);
            if (element) {
                item.addEventListener("click", (e) => {
                    e.stopPropagation();
                    this.selectElement(element);
                    element.scrollIntoView({ behavior: "smooth", block: "center" });
                });
            }
        });
    }

    generateId() {
        return "element-" + Date.now() + "-" + Math.random().toString(36).substr(2, 9);
    }

    getState() {
        const sections = Array.from(this.canvas.children).filter(el => 
            el.classList.contains("elementor-section")
        );
        return {
            elements: sections.map(section => ({
                id: section.dataset.id,
                type: "section",
                html: section.outerHTML,
                settings: section._kbSettings || {}
            }))
        };
    }

    loadState(state) {
        this.canvas.innerHTML = "";
        if (state.elements) {
            state.elements.forEach(elementData => {
                const temp = document.createElement("div");
                temp.innerHTML = elementData.html;
                const element = temp.firstElementChild;
                if (element) {
                    this.canvas.appendChild(element);
                    
                    // Restore widget references for all widgets
                    this.restoreWidgetReferences(element);
                    
                    this.makeInteractive(element);
                    element.querySelectorAll(".elementor-column, .elementor-widget").forEach(child => {
                        this.restoreWidgetReferences(child);
                        this.makeInteractive(child);
                    });
                }
            });
        }
        this.updateCanvasEmpty();
        this.updateNavigator();
    }

    restoreWidgetReferences(element) {
        // Only restore for widgets, not sections or columns
        if (element.classList.contains("elementor-widget")) {
            const widgetType = element.dataset.widget;
            if (widgetType && window.kingsBuilder && window.kingsBuilder.widgetManager) {
                const widget = window.kingsBuilder.widgetManager.getWidget(widgetType);
                if (widget) {
                    element._kbWidget = widget;
                    // Restore settings if they exist
                    if (!element._kbSettings) {
                        element._kbSettings = widget.getDefaultSettings();
                    }
                    console.log(`?? Restored widget reference for: ${widgetType}`);
                }
            }
        }
    }
}

window.CanvasManager = CanvasManager;
</script>
    <script src="./panel-manager.js?v=21"></script>
    <script src="./controls-manager.js?v=21"></script>
    <script src="./history-manager.js?v=21"></script>
    <script src="./container-toolbar.js?v=21"></script>
    <script src="./container-controls.js?v=21"></script>
    <script src="./kingsbuilder-core.js?v=21"></script>

    <!-- Initialization Script -->
    <script>
        // Global KingsBuilder instance
        let kingsBuilder = null;

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Starting KingsBuilder initialization...');
            
            try {
                // Create ContainerSystem fallback if not available
                if (typeof ContainerSystem === 'undefined') {
                    console.warn('ContainerSystem not found, creating fallback...');
                    window.ContainerSystem = class {
                        constructor() { 
                            this.initialized = false; 
                            console.log('📦 Container System (fallback) initialized');
                        }
                        async init() { 
                            this.initialized = true; 
                            console.log('✅ Container System (fallback) ready');
                        }
                        autoCreateContainer(element, target, position) {
                            // Simple fallback - just append to target
                            if (target && target.appendChild) {
                                target.appendChild(element);
                                return target;
                            }
                            return null;
                        }
                        getDefaultContainerSettings() { return {}; }
                        applyContainerSettings() {}
                    };
                }
                
                // Check if required classes are available
                const requiredClasses = ['KingsBuilderCore', 'WidgetManager', 'CanvasManager', 'PanelManager', 'ControlsManager', 'HistoryManager', 'ContainerToolbar', 'ContainerControls'];
                const missingClasses = requiredClasses.filter(className => typeof window[className] === 'undefined');
                
                if (missingClasses.length > 0) {
                    throw new Error(`Missing classes: ${missingClasses.join(', ')}`);
                }
                
                console.log('📦 All required classes loaded');
                
                // Create and initialize KingsBuilder
                kingsBuilder = new KingsBuilderCore();
                window.kingsBuilder = kingsBuilder; // Make globally available
                
                // Initialize the system
                await kingsBuilder.init();
                
                // Hide loading screen
                const loadingScreen = document.getElementById('kb-loading');
                if (loadingScreen) {
                    loadingScreen.style.opacity = '0';
                    loadingScreen.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => {
                        loadingScreen.remove();
                    }, 500);
                }
                
                console.log('✅ KingsBuilder fully loaded and ready!');
                
                // Add debug function to window for testing
                window.debugKB = function() {
                    console.log('🐛 Debug Info:');
                    console.log('- KingsBuilder instance:', window.kingsBuilder);
                    console.log('- Container controls:', window.kingsBuilder?.containerControls);
                    console.log('- Controls manager:', window.kingsBuilder?.controlsManager);
                    console.log('- Current element:', window.kingsBuilder?.selectedElement);
                    
                    // Test container controls
                    const containers = document.querySelectorAll('.kb-container');
                    console.log('- Containers found:', containers.length);
                    
                    // Test control buttons
                    const controlBtns = document.querySelectorAll('.kb-control-btn');
                    console.log('- Control buttons found:', controlBtns.length);
                    
                    // Test widget settings
                    const settingsContent = document.getElementById('kb-settings-content');
                    console.log('- Settings content:', settingsContent);
                    
                    return {
                        kingsBuilder: window.kingsBuilder,
                        containers: containers.length,
                        controlButtons: controlBtns.length,
                        settingsContent: settingsContent
                    };
                };
                
                // Add test button click handler
                window.testContainerControls = function() {
                    console.log('🧪 Testing container controls...');
                    
                    // Create a test container if none exist
                    const canvas = document.getElementById('kb-canvas');
                    if (canvas && window.kingsBuilder?.canvasManager?.containerSystem) {
                        const container = window.kingsBuilder.canvasManager.containerSystem.createContainer();
                        const column = window.kingsBuilder.canvasManager.containerSystem.createColumn();
                        container.appendChild(column);
                        canvas.appendChild(container);
                        console.log('✅ Test container created');
                        
                        // Trigger hover to show controls
                        setTimeout(() => {
                            const event = new MouseEvent('mouseover', { bubbles: true });
                            container.dispatchEvent(event);
                            console.log('✅ Hover event triggered');
                        }, 100);
                    }
                };
                
                // Show welcome message
                setTimeout(() => {
                    kingsBuilder.showNotification('Welcome to KingsBuilder! Start by dragging widgets to the canvas.', 'info');
                    console.log('💡 Debug functions available: debugKB() and testContainerControls()');
                }, 1000);
                
            } catch (error) {
                console.error('❌ Failed to initialize KingsBuilder:', error);
                console.error('Error stack:', error.stack);
                
                // Show detailed error message
                const loadingScreen = document.getElementById('kb-loading');
                if (loadingScreen) {
                    loadingScreen.innerHTML = `
                        <div style="text-align: center; color: #dc3545; max-width: 600px; padding: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <h2 style="margin: 0 0 10px 0;">Failed to Load</h2>
                            <p style="margin: 0 0 10px 0;">There was an error loading KingsBuilder:</p>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 15px 0; text-align: left; font-family: monospace; font-size: 12px; color: #dc3545;">
                                ${error.message}
                            </div>
                            <p style="margin: 0 0 20px 0; font-size: 14px;">Check the browser console for more details.</p>
                            <button onclick="location.reload()" style="
                                padding: 10px 20px;
                                background: #dc3545;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 14px;
                                margin-right: 10px;
                            ">Reload Page</button>
                            <button onclick="console.log('Debug info:', {error: '${error.message}', stack: '${error.stack}'})" style="
                                padding: 10px 20px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 14px;
                            ">Show Debug Info</button>
                        </div>
                    `;
                }
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', function(e) {
            if (kingsBuilder && kingsBuilder.canvasManager) {
                const hasContent = kingsBuilder.canvasManager.getState().elements.length > 0;
                if (hasContent) {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                    return e.returnValue;
                }
            }
        });

        // Global error handler (disabled for now to prevent spam)
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            // Only show notification for critical errors
            if (e.error && e.error.message && e.error.message.includes('Cannot read property')) {
                console.warn('Non-critical error suppressed:', e.error.message);
            } else if (kingsBuilder) {
                kingsBuilder.showNotification('An error occurred. Please check the console.', 'error');
            }
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            // Suppress common non-critical promise rejections
            if (e.reason && (
                e.reason.toString().includes('AbortError') ||
                e.reason.toString().includes('Cannot read properties of null') ||
                e.reason.toString().includes('inpage.js') ||
                e.reason.toString().includes('content.js')
            )) {
                console.warn('Non-critical promise rejection suppressed:', e.reason);
                e.preventDefault();
            } else if (kingsBuilder) {
                kingsBuilder.showNotification('An error occurred. Please check the console.', 'error');
            }
        });

        // Expose useful functions globally for debugging
        window.KingsBuilderDebug = {
            getState: () => kingsBuilder?.canvasManager?.getState(),
            getHistory: () => kingsBuilder?.historyManager?.getAllStates(),
            getWidgets: () => kingsBuilder?.widgetManager?.widgets,
            exportData: () => ({
                state: kingsBuilder?.canvasManager?.getState(),
                history: kingsBuilder?.historyManager?.exportHistory(),
                timestamp: Date.now()
            }),
            importData: (data) => {
                if (data.state) {
                    kingsBuilder?.canvasManager?.restoreState(data.state);
                }
                if (data.history) {
                    kingsBuilder?.historyManager?.importHistory(data.history);
                }
            }
        };

        // Development helpers
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('🔧 Development mode detected');
            console.log('Available debug functions:', Object.keys(window.KingsBuilderDebug));
            
            // Add development shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl+Shift+D - Toggle debug info
                if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                    e.preventDefault();
                    console.log('KingsBuilder Debug Info:', {
                        version: kingsBuilder?.version,
                        initialized: kingsBuilder?.initialized,
                        selectedElement: kingsBuilder?.selectedElement,
                        currentDevice: kingsBuilder?.currentDevice,
                        historyStates: kingsBuilder?.historyManager?.history?.length,
                        widgetCount: kingsBuilder?.widgetManager?.widgets?.size
                    });
                }
                
                // Ctrl+Shift+C - Clear canvas
                if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                    e.preventDefault();
                    if (confirm('Clear canvas? This cannot be undone.')) {
                        kingsBuilder?.canvasManager?.clear();
                    }
                }
                
                // Ctrl+Shift+E - Export data
                if (e.ctrlKey && e.shiftKey && e.key === 'E') {
                    e.preventDefault();
                    const data = window.KingsBuilderDebug.exportData();
                    console.log('Exported data:', data);
                    
                    // Download as JSON
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `kingsbuilder-export-${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            });
        }
    </script>
</body>
</html>






